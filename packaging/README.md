# Arcollect packaging guide

This directory contain files used to generate packages. If you intend to install Arcollect, check first if your distribution don't already ship a sufficiently up-to-date Arcollect, else you really should make a package.

**Important!** You must have a working internet connection to build packages, because the configuration process download additionnal dependencies.

## How to generate a package for my system ?
Do not immediately configure and build the project! Read the guide first as you may not even have to configure the project yourself or have to use special settings. You should also take a look in the [CI `build.yml`](../.github/workflows/build.yml) to see how I achieve to support some platforms and the list of packages to install before building.

### [ArchLinux](https://archlinux.org/) and derived
You can download a PKGBUILD on GitHub releases, Arcollect is not in the [AUR](https://aur.archlinux.org/) (or not by me). You can also generate a PKGBUILD using the [generate-PKGBUILD.sh](generate-PKGBUILD.sh) script in `local` mode so it sources your local repository (cd into the packaging directory first). It is written on the standard output you have to redirect to a PKGBUILD file (location doesn't matter).

```sh
	cd packaging                                                  # You must be in the package directory
	mkdir /tmp/arcollect-build                                    # PKGBUILD working directory, choose at your convenience
	sh generate-PKGBUILD.sh local > /tmp/arcollect-build/PKGBUILD # Generate the PKGBUILD
	cd /tmp/arcollect-build                                       # Go into the PKGBUILD working directory
	makepkg -i                                                    # Build (-i option to also install)
```

### [Debian](https://www.debian.org/) and derived
*Well... the process to create a source package is heavy and I didn't understood all details.* The binary Debian package is manually generated by the build-system. *Yes, that's dirty ðŸ™ˆï¸ !*

Release configuration is done by yourself. **You must [change the installation prefix to `/usr`](https://lintian.debian.org/tags/dir-in-usr-local)**, also turning on [stripping](https://lintian.debian.org/tags/unstripped-binary-or-object) and [BIND_NOW](https://lintian.debian.org/tags/hardening-no-bindnow) is required to pass lintian checks and you probably want to turn optimizations on. Note that this is really not *the Debian way*, while the package might works and I tried to reduce lintian output, it is not a high quality Debian packaging.

```sh
	meson build --prefix=/usr -Dbuildtype=release -Dstrip=true -Db_lto=true -Dcpp_link_args='-z now'
	# Search for the Debian package filename output
	DEBNAME="$(grep -oEm 1 "arcollect_[0-9\.]+-1_$(echo -n "$(dpkg-architecture -q DEB_HOST_ARCH)").deb" build/build.ninja)"
	ninja -C build packaging/$DEBNAME
	# Debian package sanity checks
	lintian packaging/$DEBNAME
	# Install package
	sudo dpkg -i packaging/$DEBNAME
```

### [Microsoft Windows](https://www.microsoft.com/windows)
Microsoft Windows MSI is generated by the [WiX Toolset](https://wixtoolset.org/). [Install WiX version 4](https://wixtoolset.org/docs/intro/#nettool) and ensure that the `wix.exe` CLI is in the `PATH` (`wix --version` must work), then install the `WixToolset.UI.wixext` WiX extension.

The `install` target will not works on Microsoft Windows system. You must generate a MSI and also may want to enable release mode build, **you should also force-fallback all wraps and turn on static linkings** to avoid missing DLL problems (everything in the *Using system dependency* summary must be set to *NO*). Then simply generate the `packaging/arcollect-en_US.msi` target.

Arcollect support localized MSI, these only differ by the installer interface language, installed files are the same. Technics for multi-lingual MSI packages exists so this would be a welcomed addition in Arcollect.


```sh
	# Install WiX
	dotnet tool install --global wix
	wix extension add -g WixToolset.UI.wixext
	# Configure the project
	meson setup build -Dbuildtype=release -Dstrip=true -Db_lto=true --force-fallback-for=freetype2,fmt,bzip2,giflib,libpng,Imath,inih,lcms2,libcurl,libjpeg,libtiff,OpenImageIO,robin-map,roboto,sdl2,harfbuzz,sqlite3 -Denable_webextension=false -Dcpp_link_args=-static -Dc_link_args=-static
	# Build and run tests
	# They should fail if the .exe is not standalone
	ninja -C build test
	# Generate the MSI
	ninja -C build packaging/arcollect-en_US.msi
	ninja -C build all-msi # To generate all localized MSI variants
	# Install the MSI
	msiexec /i packaging/arcollect-en_US.msi
```

### [Flatpak](https://flatpak.org/)
There is an experimental Flatpak support with the [generate-flatpak.sh](generate-flatpak.sh). Run the script in `local` mode (cd into the packaging directory first). It is written on the standard output you have to redirect to a .yml file (location doesn't matter). Since network access is disabled within the build sandbox, you need to predownload subprojects using `meson subprojects download`.

```sh
	meson subprojects download                                      # Predownload subprojects
	cd packaging                                                    # You must be in the package directory
	mkdir /tmp/arcollect-build                                      # FlatPak working directory, choose at your convenience
	sh generate-flatpak.sh local > /tmp/arcollect-build/flatpak.yml # Generate the FlatPak
	cd /tmp/arcollect-build                                         # Go into the FlatPak working directory
	mkdir build-dir                                                 # Create the Flatpak build-dir
	flatpak-builder build-dir flatpak.yml ...                       # Invoke Flatpak builder
```

Arcollect is currently unusable this way since WebExtensions native messaging doesn't work yet with Flatpak (see this [portal PR](https://github.com/flatpak/xdg-desktop-portal/pull/705) and [Firefox bug](https://bugzilla.mozilla.org/show_bug.cgi?id=1621763)).

### Other
There is no packaging support. Actually, I will be suprised that someone packaged Arcollect. You should create one, or just install in `/usr/local` prefix, this is strongly discouraged :

```sh
	# Enable release configuration
	meson setup build -Dbuildtype=release -Dstrip=true #-Db_lto=true if you want LTO
	# Build
	meson compile -C build
	# Build and install (run as root)
	ninja install -C build
```
