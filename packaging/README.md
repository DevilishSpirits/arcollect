# Arcollect packaging guide

This directory contain files used to generate packages. If you intend to install Arcollect, you really should make a package.

**Important!** You must have a working internet connection to build packages, because the configuration process download additionnal dependencies.

**Warning!** In addition of the application, some other libraries may be built and use a lot of disk space. On recent Linux systems expect around 250MB and 1.2GB on Windows platforms where everything is embeded.

## How to generate a package for my system ?
Don't immediately configure and build the project, package generation is likely to redo this from scratch and there is some configuration you must change. Install Meson and follow system specific instructions. You should also take a look in [`.github/workflows/release.yml`](https://github.com/DevilishSpirits/arcollect/blob/master/.github/workflows/release.yml) to see how releases are made, it may contain workaround missing there.
```sh
	# Ensure that you have a working version of Meson
	pip3 install meson>=0.59.0
	# That's all for now
```

### [ArchLinux](https://archlinux.org/) and derived
Install dependencies and then configure the project into the `build` directory but do not build it, the PKGBUILD will reconfigure it from scratch. Then `cd` into `build/packaging` that contain configured `PKGBUILD` and run [`makepkg`](https://man.archlinux.org/man/makepkg.8) **with the `PKGBUILD.local` file !** Else you will download a release from GitHub. Note that the [PKGBUILD](https://github.com/DevilishSpirits/arcollect/blob/master/packaging/PKGBUILD.in#L15) force a release configuration with LTO and optimizations turned on.

```sh
	meson build
	# NOTE! If you install dependencies. Wipe `build` and configure again to get correct dependencies listing.
	cd build/packaging
	makepkg -p PKGBUILD.local
```

### [Debian](https://www.debian.org/) and derived
*Well... the process to create a source package is heavy and I didn't understood all details.* The binary Debian package is manually generated by the build-system. *Yes, that's dirty üôàÔ∏è !*

Release configuration is done by yourself. **You must [change the installation prefix to `/usr`](https://lintian.debian.org/tags/dir-in-usr-local)**, also turning on [stripping](https://lintian.debian.org/tags/unstripped-binary-or-object) and [BIND_NOW](https://lintian.debian.org/tags/hardening-no-bindnow) is required to pass lintian checks and you probably want to turn optimizations on. Note that this is really not *the Debian way*, while the package might works and I tried to reduce lintian output, it is not a high quality Debian packaging.

```sh
	meson build --prefix=/usr -Dbuildtype=release -Dstrip=true -Db_lto=true -Dunity=on -Dcpp_link_args='-z now'
	# Search for the Debian package filename output
	DEBNAME="$(grep -oEm 1 "arcollect_[0-9\.]+-1_$(echo -n "$(dpkg-architecture -q DEB_HOST_ARCH)").deb" build/build.ninja)"
	ninja -C build packaging/$DEBNAME
	# Debian package sanity checks
	lintian packaging/$DEBNAME
	# Install package
	sudo dpkg -i packaging/$DEBNAME
```

### [Microsoft Windows](https://www.microsoft.com/windows)
Microsoft Windows MSI is generated by the [WiX Toolset](https://wixtoolset.org/). Install WiX version 3, ensure that their `candle.exe` and `light.exe` are in the `PATH`.

The `install` target will not works on Microsoft Windows system. You must generate a MSI and also may want to enable release mode build, **you should also force-fallback all wraps and turn on static linkings** to avoid missing DLL problems (everything in the *Using system dependency* summary must be set to *NO*). Then simply generate the `packaging/arcollect.msi` target.

```sh
	meson setup build -Dbuildtype=release -Dstrip=true -Db_lto=true --force-fallback-for=freetype2,fmt,bzip2,giflib,libpng,Imath,inih,lcms2,libcurl,libjpeg,libtiff,OpenImageIO,rapidjson,robin-map,roboto,sdl2,freetype2,harfbuzz,sqlite3,zlib -Denable_webextension=false -Dcpp_link_args=-static -Dc_link_args=-static
	# Build and run tests
	# They should fail if the .exe is not standalone
	ninja -C build test
	# Generate the MSI
	ninja -C build packaging/arcollect.msi
	# Install the MSI
	msiexec /i packaging/arcollect.msi
```

If the `packaging/arcollect.msi` target is missing, this mean that `candle.exe` and `light.exe` have not been found, hence the target was not generated, look for 'Program **candle** found: **NO**' configuration message. You may create in the `packaging` directory `candle` and `light` wrapper scripts to solve this (I did that to generate tests MSI on ArchLinux using Wine).

### Other
There is no packaging support. Actually, I will be suprised that someone packaged Arcollect. You can create one or use just install in `/usr/local` prefix :

```sh
	# cd into `build`
	cd ..
	# Enable release configuration
	meson configure -Dbuildtype=release -Dstrip=true -Db_lto=true
	# Build and install
	ninja install
```
