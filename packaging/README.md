# Arcollect packaging files

This directory contain files used to generate packages. You probably won't need these unless you want to package a custom version.

**Important!** You must have a working internet connection to build packages from source tarballs. The configuration process download additionnal dependencies.

## How to generate a package for my system ?
Configure the project into the `build` directory but do not build it, package generation will do it's own configuration/build process anyway. Then `cd` into `build/packaging` that contain configured versions of files under `packaging` and follow system specific instructions :

```sh
	# cd to_source_root
	meson build        # Configure in 'build' directory
	cd build/packaging
```

You may want to take a look into the *release* GitHub Actions workflow at [`.github/workflows/release.yml`](https://github.com/DevilishSpirits/arcollect/blob/master/.github/workflows/release.yml) to see exactly how releases are generated.

### [ArchLinux](https://archlinux.org/) and derived
Run [`makepkg`](https://man.archlinux.org/man/makepkg.8) **with the `PKGBUILD.local` file !** Else you will download a release from GitHub, it's either useless or unwanted if you want to build a version with local modifications. Note that the PKGBUILD force a release configuration with LTO and optimizations turned on.

```sh
	makepkg -p PKGBUILD.local
```

### [Debian](https://www.debian.org/) and derived
*Well... the process to create a source package is heavy and I didn't understood all details.* The binary Debian package is manually generated by the build-system. *Yes, that's dirty üôàÔ∏è !*

First, checkout the [Installation section](https://github.com/DevilishSpirits/arcollect#installation) of main README.md and install development version of packages that aren't *Known buggy*. 

Unlike other systems, you will build the directory you configured. This mean that you must configure the project to generate a correct package. **You must [change the installation prefix to `/usr`](https://lintian.debian.org/tags/dir-in-usr-local)**, also turning on [stripping](https://lintian.debian.org/tags/unstripped-binary-or-object) and [BIND_NOW](https://lintian.debian.org/tags/hardening-no-bindnow) is required to pass lintian checks and you probably want to turn optimizations on. Note that this is really not *the Debian way*, while the package might works and I tried to reduce lintian output, it is not a high quality packaging.

```sh
	meson configure build --prefix=/usr -Dbuildtype=release -Dstrip=true -Db_lto=true -Dunity=on -Dcpp_link_args='-z now'
	# Search for the Debian package filename output
	DEBNAME="$(grep -oEm 1 "arcollect_[0-9\.]+-1_$(echo -n "$(dpkg-architecture -q DEB_HOST_ARCH)").deb" build/build.ninja)"
	ninja -C build packaging/$DEBNAME
	lintian packaging/$DEBNAME # Check for errors
	sudo dpkg -i packaging/$DEBNAME
```

### [Microsoft Windows](https://www.microsoft.com/windows)
**This is a work in progress !**

Microsoft Windows MSI is generated by the [WiX Toolset](https://wixtoolset.org/). Install WiX version 3, ensure that their `candle.exe` and `light.exe` are in the `PATH`.

Unlike other systems, you will build the directory you configured. Configure the project to tweaks some parameters like enabling release mode build, **you should also force-fallback all wraps** to avoid missing DLL problems (everything in the *Using system dependency* must be set to *NO*). Then simply generate the `packaging/arcollect.msi` target.

```sh
	# Remove --wipe if you have not run `meson build` yet or your deleted the build dir
	meson setup build --wipe -Dbuildtype=release -Dstrip=true -Db_lto=true --force-fallback-for=libcurl,sdl2,sdl2_image,sdl2_ttf,sqlite3,INIReader,freetype2,libjpeg,libpng,libtiff-4,zlib
	# Build and run tests
	# They'll fail if the .exe is not standalone
	ninja -C build test
	# Generate the MSI
	ninja -C build packaging/arcollect.msi
```

If the `packaging/arcollect.msi` is missing, this mean that `candle.exe` and `light.exe` have not been found and the target was not generated, look for 'Program **candle**/**light** found: **NO**' configuration message. You may create in the `packaging` directory `candle` and `light` wrapper scripts to solve this. I do that in ArchLinux to generate MSI.
